# 推荐算法文档

项目根目录:

`/root/hw/推荐算法`

运行环境:

`conda activate hw`

## 部署
```bash
# 单进程
nohup python api_recommend.py >  api_recommend-nohup.log &

# 多进程
# 2 * cpu_n + 1
nohup uvicorn api_recommend_multiproc:app --workers 2 --host 61.142.208.114 --port 7870 > api_recommend_multiproc-nohup.log &

# 如何kill:

# 由于多进程uvicorn的模式是单父进程多子进程，所以不能直接使用 kill -9 杀掉父进程id. 这里提供一个自建命令killu来一键杀掉子进程和父进程
killu <PID>

# 若killu没有用, 如何杀掉多进程的uvicorn后端: 
# 先删所有子进程:
# api -> 查找父进程
kill $(pgrep -P $uvicorn_father_pid)
# 再删父进程:
kill -9 $uvicorn_pid # 再删父进程

# 一不小心删了父进程, 走投无路:
pkill -9 -f ".*/root/anaconda3/envs/hw/bin/python3.11 -c from multiprocessing.spawn import spawn_main; spawn_.*"
```

## 推荐算法逻辑

0. 推荐算法总接口 **对应函数**: `Recommendation.get_recommend(self, id: int, filter: tuple[tuple[int, int]], cities: list[str], max_n: int) -> list[Result]`
1. 获得待推荐人user_id, es中查找待推荐人信息 **对应函数**: `Recommendation.get_my_info(self, id: int) -> UserInfo`
2. 根据过滤条件在es中随机选取100条匹配记录, 从图谱接口获得相似用户关注的用户(最多30个用户) **对应函数**: `Recommendation.select_matches(self)` `Recommendation.select_from_user_graph(self)`
3. 对100条记录进行打分, 取最高分的max_n(由调用程序设置)条作为返回结果 **对应函数**: `Recommendation.cal_score(self, matches: list[UserInfo]) -> list[Result]`

> 自我介绍和爱情观使用TF-IDF算法提取关键词，计算相似度, 计入分数。函数: `Recommendation.calculate_correlation(self, match: UserInfo) -> int`, 由`cal_score()`调用

## 代码结构

|文件名|作用|启动命令|关闭命令|
|:---:|:---|:---|:---|
|api_recommend_multiproc.py|推荐算法的接口, 由于是uvicorn的多进程接口, 无法直接使用python命令运行，需要使用deploy.sh中的命令|nohup uvicorn api_recommend_multiproc:app --workers 2 --host 61.142.208.114 --port 7870 > api_recommend_multiproc-nohup.log &|使用`killu <PID>` 或者 使用`kill -9 $(pgrep -P $uvicorn_father_id) && kill -9 $uvicorn_father_id`  ($uvicorn_father_id: 一个形如`/root/anaconda3/envs/hw/bin/python3.11 /root/anaconda3/envs/hw/bin/uvicorn api_recommend_multiproc:app --workers 2 --host 61.142.208.114 --port 7870` 的进程的id)先杀掉uvicorn的所有子worker进程!! **请绝对不要直接使用`kill -9`杀掉uvicorn的父进程**，不然所有的子worker进程得一个一个删|
|api_recommend.py|推荐算法单线程接口, 可以直接使用python命令运行, 方便调试|nohup python api_recommend.py >  api_recommend-nohup.log &|kill -9 \<PID\>|
|algorithm_recommend.py|推荐算法核心代码|无，仅为推荐系统模块|无，仅为推荐系统模块|
|user_list.py|添加、删除、更新用户信息|无，仅为推荐系统模块|无，仅为推荐系统模块|
|black_list.py|添加、删除用户黑名单|无，仅为推荐系统模块|无，仅为推荐系统模块|
|save_chat.py|添加用户对话记录|无，仅为推荐系统模块|无，仅为推荐系统模块|
|follow.py|添加、删除用户关注列表|无，仅为推荐系统模块|无，仅为推荐系统模块|

#### 打分
推荐算法打分部分分为:
1. 规则分数矩阵(细则, 见附件`推荐规则_zhw.xlsx`)
2. TF-IDF算法对恋爱观和自我介绍的关键词提取, 进行相关度分析

## 用户列表
代码: `/root/hw/推荐算法/user_list.py`

表名: `user_list`

表结构(schema): `mappings/user_info.json`或见`es_userlist.ipynb`

1. 用户列表的接口见接口文档`推荐算法接口.md`
2. 用户列表使用最少的、可供计算用户分数的字段用于存储, 当然，存储所有字段也是可以的。

## 黑名单
代码: `/root/hw/推荐算法/black_list.py`

表名: `black_list`

表结构(schema):  见`es_blacklist.ipynb`

黑名单用于屏蔽某个用户，推荐接口将不会推荐此用户

## 保存用户聊天记录
代码: `/root/hw/推荐算法/save_chat.py`

表名: `user_chat`

表结构(schema):  见`es_user_chat.ipynb`

保存用户聊天记录

## 关注列表
代码: `/root/hw/推荐算法/follow.py`

表名: `follow`

表结构(schema):  见`es_follow.ipynb`

推荐接口将不会推荐已关注的用户

## 用户图谱
根目录: `/root/haoyu/ElasticSearch/neo4j`

用户图谱将会推荐相似用户关注的用户(如两个男用户Nan1, Nan2相似，为Nan1寻找推荐用户时，推荐Nan2关注的用户)
由于是**陈浩宇**负责，具体逻辑请参见他的文档[图谱推荐接口文档](http://192.168.20.196/svn/matchmakin/01.CI/1.4%20Design/1.4.1%20SD/Draft/%E6%8E%A5%E5%8F%A3/%E5%9B%BE%E8%B0%B1%E6%8E%A8%E8%8D%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3.pdf)

## es快速调试

> 运行环境: 全部都为hw

> .ipynb为jupyter notebook, 使用vscode的远程ssh插件可以非常方便地运行

|文件名|作用|
|:---:|:---:|
|es_blacklist.ipynb|黑名单表快速操作|
|es_follow.ipynb|关注列表快速操作|
|es_user_chat.ipynb|用户聊天记录表快速操作|
|es_userlist.ipynb|用户列表快速操作|

## 未来优化
1. 改进nohup的输出重定向，使用python的日志库logging来打印日志到日志文件。
2. 使用深度学习模型和大数据分析框架创造一个更加强大的推荐系统
3. 使用`gunicorn`来管理多进程接口(以改善繁琐的杀进程流程)
